# box_slang_i18n 产品需求文档（PRD）

## 1. 背景与定位

### 1.1 背景

在 Flutter 多语言项目中，基于 `slang` 的 i18n JSON 文件往往存在以下长期痛点：

* key 数量庞大，排序与结构不统一
* 配置文件（如 slang_i18n.yaml）容易缺失或被误改
* 多语言增量翻译成本高，重复劳动严重
* 多人协作时，i18n 目录结构与语言文件质量难以保持一致

### 1.2 工具定位

`box_slang_i18n` 是一个 **CLI 工具**，隶属于 `box` 工具集，专注于 **Flutter slang i18n 资源的生命周期管理**：

* 初始化（init）
* 结构与环境诊断（doctor）
* 排序与规范化（sort）
* AI 辅助翻译（translate）

该工具强调：

* 强约定、可诊断、可自动修复
* 保留人工可读性（保留注释、不破坏格式）
* 增量优先，避免无意义全量改动

---

## 2. 设计原则

1. **配置即真相**

    * 一切行为以 `slang_i18n.yaml` 为中心
    * CLI 参数仅作为覆盖，不隐式修改配置

2. **安全默认值**

    * 默认不做破坏性操作
    * 翻译默认增量模式

3. **可诊断性优先**

    * 所有失败都给出可行动的提示
    * `doctor` 是一等公民

4. **静态声明，动态执行**

    * 工具元信息（BOX_TOOL）必须是纯静态字面量
    * 运行期逻辑全部在 CLI 内完成

---

## 3. 用户画像与使用场景

### 3.1 用户画像

* Flutter 工程师
* 使用 slang / JSON 作为 i18n 方案
* 中大型项目（10+ 语言）
* 对工具可控性与可维护性有要求

### 3.2 典型场景

* 新项目初始化 i18n 目录
* CI 前对 i18n 文件做结构校验
* 日常新增 key 后做排序
* 翻译新语言或补齐缺失翻译

---

## 4. 功能需求

### 4.1 init —— 初始化与配置校验

#### 目标

* 降低项目首次接入 slang i18n 的成本
* 确保配置文件与目录结构一致

#### 行为

* 若 `slang_i18n.yaml` 不存在：

    * 生成默认模板（保留注释）
* 若存在：

    * 校验 YAML 合法性
* 确保：

    * `languages.json` 存在
    * `i18nDir` 目录存在（必要时创建）

#### 失败情况

* YAML 语法错误 → 明确指出行号
* 路径无权限 → 给出修复建议

---

### 4.2 doctor —— 环境与结构诊断

#### 目标

* 在执行破坏性操作前，提前暴露问题

#### 检查项

* 配置文件是否存在且合法
* i18n 目录结构是否符合约定
* JSON 文件是否可解析
* 是否存在非法 key（如 @@locale 冲突）
* flat / nested 结构一致性

#### 输出

* 明确区分：error / warn / hint
* 所有问题必须可定位、可修复

---

### 4.3 sort —— i18n 文件排序

#### 目标

* 降低 diff 噪音
* 保持多语言 key 顺序一致

#### 行为

* 读取 source language（通常为 baseLocale）
* 按工具规则排序 key
* 同步排序所有 target language
* 保留原有注释与格式

#### 非目标

* 不修改 key 内容
* 不自动删除 key

---

### 4.4 translate —— AI 翻译

#### 模式

##### 增量模式（默认）

* 仅翻译缺失 key
* 不覆盖已有翻译
* 自动跳过 @@locale

##### 全量模式（--no-incremental）

* 以 source 为准
* 覆盖生成 target 翻译

#### 依赖

* OpenAI API
* 明确失败重试与速率限制提示

#### 安全性

* 明确告知：翻译结果需人工 review

---

## 5. CLI 设计

### 5.1 命令

* `box_slang_i18n`
* `box_slang_i18n init`
* `box_slang_i18n sort`
* `box_slang_i18n doctor`
* `box_slang_i18n translate`

### 5.2 全局参数

* `--config`：配置文件路径（默认 slang_i18n.yaml）
* `--project-root`：项目根目录（默认当前目录）
* `--i18n-dir`：覆盖配置中的 i18nDir

---

## 6. 元信息与发布约束

### 6.1 BOX_TOOL 约束

* 必须为 **纯字面量 dict**
* 禁止：

    * f-string
    * 变量引用
    * 函数调用

### 6.2 工具集集成

* 通过 `box tools` 可发现
* `box tools --full` 展示完整 usage / options / examples
* 更新通过 `box update`

---

## 7. 非功能性需求

* 启动速度 < 300ms（不含翻译）
* 错误信息必须中文、可执行
* 所有默认行为必须可预测

---

## 8. 不在本期范围（明确排除）

* GUI 界面
* 自动提交 git
* 自动发布 slang 代码生成
* 翻译质量保证（仅提供工具能力）

---

## 9. 成功标准

* 新项目 5 分钟内完成 i18n 初始化
* 日常 i18n 维护不再依赖手工排序
* 翻译流程从“人工 copy-paste”变为“review 为主”

---

## 10. 结语

`box_slang_i18n` 不是“又一个翻译工具”，而是一个 **对 i18n 混乱保持零容忍的工程化助手**。它的价值不在于“做得多”，而在于“永远做对、做稳、做可解释的事”。
